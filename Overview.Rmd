---
title: "Global child malnutrition overview"
output:
  html_document: default
---

```{r setup, include=FALSE}
setwd("C:/Users/crish/OneDrive/Documents/Columbia SIPA/2017 Spring/Data Visualization/Final Project/")

library(readr)
jme_latest <- readstata13::read.dta13("data/JME_2016_latest.dta")
jme <- readstata13::read.dta13("data/JME_2016.dta")
disparities <- readstata13::read.dta13("data/stunting disparities.dta")
```

## Nearly half of all deaths in children under 5 are attributable to undernutrition

Undernutrition puts children at greater risk of dying from common infections, increases the frequency and severity of such infections, and contributes to delayed recovery. 

Poor nutrition in the first 1,000 days of a child's life can also lead to stunted growth, which is irreversible and associated with impaired cognitive ability and reduced school and work performance.

####Forms of malnutrition
Stunting: refers to a child who is too short for his or her age. Stunting is the failure to grow both physically and cognitively and is the result of chronic or recurrent malnutrition. The devastating effects of stunting can last a lifetime. 

Wasting: refers to a child who is too thin for his or her height. Wasting, or acute malnutrition, is the result of recent rapid weight loss or the failure to gain weight. A child who is moderately or severely wasted has an increased risk of death, but treatment is possible. 

```{r, include=FALSE}
library(raster)
world_spdf <- shapefile("C:/Users/crish/OneDrive/Documents/Columbia SIPA/2017 Spring/Data Visualization/Final Project/data/world_map/TM_WORLD_BORDERS_SIMPL-0.3.shp")

# Merge the QoG data to Shape Files
library(dplyr)
mapjme <- world_spdf@data %>% left_join(jme_latest, by = c(ISO3 = "iso"))
world_spdf@data <- mapjme

```

####Map 1. Prevalence of wasting and stunting per country

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center'}

library(leaflet)
leaflet(world_spdf) %>% 
  addProviderTiles("Esri.WorldGrayCanvas")  %>% 
  setView(lat=25, lng=2.8 , zoom=2) %>%
  
    # Base groups = Background layer
    addTiles(group = "OpenStreetMap") %>%
    addProviderTiles(providers$Stamen.TonerLite, group = "Toner Lite") %>%
    addProviderTiles(providers$Stamen.Toner, group = "Toner")  %>%
    
    # Data Layers
      # First Data Layer
    addPolygons(group="Wasting", data=world_spdf,
                stroke = FALSE, fillOpacity = 1, smoothFactor = 0.5, 
                color = ~colorNumeric("Blues", wasting)(wasting),
                popup = paste("Country:",world_spdf$NAME,"<br/>",
                              "Wasting prevalence:", world_spdf$wasting,"%","<br/>")) %>%
    addLegend("bottomright", pal = colorNumeric("Blues", world_spdf$wasting), 
              values = ~wasting, title = "% Wasting", opacity = 1) %>%
  
  # Second Data Layer:
  addPolygons(group="Stunting",
                stroke = FALSE, fillOpacity = 1, smoothFactor = 0.5, 
                color = ~colorQuantile("Reds", stunting)(stunting),
                popup = paste("Country:",world_spdf$NAME,"<br/>",
                              "Stunting prevalence:", world_spdf$stunting,"%","<br/>")) %>%
  addLegend("bottomright", pal = colorNumeric("Reds", world_spdf$stunting), 
            values = ~stunting, title = "% Stunting", opacity = 1) %>%
  
    # Layers control
    addLayersControl(
    baseGroups = c("OpenStreetMap", "Toner", "Toner Lite"),
    overlayGroups = c("Stunting","Wasting"),
    options = layersControlOptions(collapsed = TRUE) )
```


##The relationship between wasting and stunting 

Countries with higher levels of stunting that demand immediate attention...

```{r, include=FALSE}
library(ggplot2)
library(ggthemes)
library(scales)

ggplot(jme_latest, aes(x=stunting, y=wasting, color=region)) + geom_point(alpha=0.5, size=3) + 
  ggtitle("Prevalence of stunting and wasting") + 
  labs(x="Stunting (%)", y = "Wasting (%)", size=8) +
  theme_classic(base_size = 12) + theme(text = element_text(color = "gray20"),
                                        axis.text.x = element_text(NULL),
          legend.position = c("bottom"),
          axis.text = element_text(face = "italic"),
          axis.title.x = element_text(vjust = -1),
          axis.title.y = element_text(vjust = 2),
          axis.ticks.y = element_blank(),
          axis.line = element_line(color = "gray40", size = 0.5),
          axis.line.y = element_blank(),
          panel.grid.major = element_line(color = "gray50", size = 0.5),
          panel.grid.major.x = element_blank(),
          plot.margin = margin(t = 0, r = 0, b = 40, l = 5, unit = "pt"),
          plot.title = element_text(face = "bold", color = "black", size = 11, hjust=0.5))
```

#### Graph 1. Relationship between stunting and wasting prevalence

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center'}
library(plotly) 
plot_ly(jme_latest, x = ~stunting, y=~wasting, 
                     color = ~region, type = "scatter",
                     text = ~paste(country, 'Year:', year))
```



At a regional level, South Asia is the most affected region with over 20 million children with malnutrition. 

####Graph 2. Number of children wasted, per region
```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(ggplot2)
library(ggthemes)
library(scales)

jme2014 <- jme[which(jme$year=='2014'),]

ggplot(subset(jme2014), aes(x=region, y=num_wasting, fill=region)) + geom_bar(stat = "identity") + 
         scale_fill_brewer(palette="YlGnBu") + coord_flip() +
  #ggtitle("Graph 1. Number of children wasted, 2014") + 
  labs(x="", y = "Children wasted", size=8) +
  theme_classic(base_size = 12) + theme(text = element_text(color = "gray20"),
                                        axis.text.x = element_text(NULL),
          legend.position = c("none"),
          axis.text = element_text(face = "italic"),
          axis.title.x = element_text(vjust = -1),
          axis.title.y = element_text(vjust = 2),
          axis.ticks.y = element_blank(),
          axis.line = element_line(color = "gray40", size = 0.5),
          axis.line.y = element_blank(),
          panel.grid.major = element_line(color = "gray50", size = 0.5),
          panel.grid.major.x = element_blank(),
          plot.margin = margin(t = 0, r = 0, b = 40, l = 5, unit = "pt"),
          plot.title = element_text(face = "bold", color = "black", size = 11, hjust=0.5))
```


###Trends in malnutrition prevalence

```{r, include=FALSE}

jmeyears <- jme[which(jme$year=='2000' | jme$year=='2006' | jme$year=='2010' | jme$year=='2014'),]

ggplot(data=jmeyears, aes(x=year, y=num_wasting, fill=year)) + geom_bar(stat = "identity") + 
         scale_fill_brewer(palette="YlGnBu") + 
  ggtitle("Graph 1. Number of children wasted, 2014") + 
  labs(x="", y = "Number of children wasted", size=8) +
  theme_classic(base_size = 12) + theme(text = element_text(color = "gray20"),
                                        axis.text.x = element_text(NULL),
          legend.position = c("none"), 
          axis.text = element_text(face = "italic"),
          axis.title.x = element_text(vjust = -1),
          axis.title.y = element_text(vjust = 2),
          axis.ticks.y = element_blank(),
          axis.line = element_line(color = "gray40", size = 0.5),
          axis.line.y = element_blank(),
          panel.grid.major = element_line(color = "gray50", size = 0.5),
          panel.grid.major.x = element_blank(),
          plot.margin = margin(t = 0, r = 0, b = 40, l = 5, unit = "pt"),
          plot.title = element_text(face = "bold", color = "black", size = 11, hjust=0.5))
```


```{r, include=FALSE}
stunting_global <- c(39.6 , 35.7 , 32.7 , 29.4 , 24.4 , 23.2)
year <- c("1990", "1995", "2000", "2005", "2010", "2015") 
trend_stunting_global <- data.frame(stunting_global,year)
names(trend_stunting_global) <- c("stunting_global","year")

library(ggplot2)
library(ggthemes)
library(scales)
ggplot(data=trend_stunting_global, aes(x=year, y=stunting_global)) + 
  geom_bar(stat = "identity", fill="#009FDF") + 
  scale_fill_brewer(palette="YlGnBu") +
  ggtitle("Graph 1. Trends in stunting prevalence, 1990-2015") + 
  labs(x="", y = "Children given MNP", size=8) +
  theme_classic(base_size = 12) + theme(text = element_text(color = "gray20"),
                                        axis.text.x = element_text(NULL),
          legend.position = c("bottom"), legend.direction = "horizontal",
          legend.justification = 0.05, legend.text = element_text(size = 9, color = "gray10"),
          legend.key.height=unit(1,"line"), legend.key.width=unit(1,"line"),
          axis.text = element_text(face = "italic"),
          axis.title.x = element_text(vjust = -1),
          axis.title.y = element_text(vjust = 2),
          axis.ticks.y = element_blank(),
          axis.line = element_line(color = "gray40", size = 0.5),
          axis.line.y = element_blank(),
          panel.grid.major = element_line(color = "gray50", size = 0.5),
          panel.grid.major.x = element_blank(),
          plot.margin = margin(t = 0, r = 0, b = 40, l = 5, unit = "pt"),
          plot.title = element_text(face = "bold", color = "black", size = 11, hjust=0.5))
```


#### Global prevalence of stunting, 1995-2015

Malnutrition rates remain alarming: stunting is declining too slowly while

```{r, echo=FALSE}
plot_ly(trend_stunting_global, x = ~year, y=~stunting_global, 
                     type = "bar",
                     text = ~paste('Stunting (%):',stunting_global, 'Year:', year))
```



####Regional trends

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(ggplot2)
library(ggthemes)
library(scales)

jme0614 <- jme[which(jme$year=='2006' | jme$year=='2014'),]

ggplot(jme0614, aes(x=year, y=stunting)) + 
  geom_boxplot() +
  geom_jitter(size = 4, alpha = 0.5, aes(col = region, size=year), na.rm = TRUE)  + facet_grid(. ~ region) +
  ggtitle("Graph 1. Percentage of stunting per region, 2006-2014") + 
  labs(x="", y = "Stunting (%)", size=8) +
  ggthemes::theme_few(base_size = 12) + theme(text = element_text(color = "gray20"),
                                        axis.text.x = element_text(NULL),
          legend.position = c("none"), 
          axis.text = element_text(face = "italic"),
          axis.title.x = element_text(vjust = -1),
          axis.title.y = element_text(vjust = 2),
          axis.ticks.y = element_blank(),
          axis.line = element_line(color = "gray40", size = 0.5),
          axis.line.y = element_blank(),
          panel.grid.major = element_line(color = "gray50", size = 0.5),
          panel.grid.major.x = element_blank(),
          plot.margin = margin(t = 0, r = 0, b = 40, l = 5, unit = "pt"),
          plot.title = element_text(face = "bold", color = "black", size = 11, hjust=0.5))
```





```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(ggplot2)
library(ggthemes)
library(scales)

ggplot(jme0614, aes(x=year, y=wasting)) + 
  geom_boxplot() +
  geom_jitter(size = 4, alpha = 0.5, aes(col = region, size=year), na.rm = TRUE)  + facet_grid(. ~ region) +
  ggtitle("Graph 1. Percentage of wasting per region, 2006-2014") + 
  labs(x="", y = "Wasting (%)", size=8) +
  ggthemes::theme_few(base_size = 12) + theme(text = element_text(color = "gray20"),
                                        axis.text.x = element_text(NULL),
          legend.position = c("none"), 
          axis.text = element_text(face = "italic"),
          axis.title.x = element_text(vjust = -1),
          axis.title.y = element_text(vjust = 2),
          axis.ticks.y = element_blank(),
          axis.line = element_line(color = "gray40", size = 0.5),
          axis.line.y = element_blank(),
          panel.grid.major = element_line(color = "gray50", size = 0.5),
          panel.grid.major.x = element_blank(),
          plot.margin = margin(t = 0, r = 0, b = 40, l = 5, unit = "pt"),
          plot.title = element_text(face = "bold", color = "black", size = 11, hjust=0.5))
```

#### Table 1. Wasting and stunting prevalences, 2000-2014

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=3, fig.align='center'}

myvars <- c("country", "region", "year", "wasting", "stunting", "pop5")
jme_short <- jmeyears[myvars]

#install.packages("DT")
library(DT)
datatable(jme_short, 
          colnames = c('Country', 'Region', 'Year', 'Wasting (%)', 
                       'Stunting (%)', 'Children < 5 years old (000)'), 
          filter = 'top', options = list(pageLength = 10, autoWidth = TRUE))
```

Data...

```{r, include=FALSE}
library(raster)
world_spdf <- shapefile("data/world_map/TM_WORLD_BORDERS_SIMPL-0.3.shp")

# Merge the QoG data to Shape Files
library(dplyr)
mapdisparities <- world_spdf@data %>% left_join(disparities, by = c(ISO3 = "iso"))
world_spdf@data <- mapdisparities

```


#Disparities between malnutrition and wealth

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(leaflet)
leaflet(world_spdf) %>% 
  addProviderTiles("Esri.WorldGrayCanvas")  %>% 
  #setView(lat=34.612255, lng=-22.300443 , zoom=10) %>%
    # Base groups = Background layer
    addTiles(group = "OpenStreetMap") %>%
    addProviderTiles(providers$Stamen.TonerLite, group = "Toner Lite") %>%
    addProviderTiles(providers$Stamen.Toner, group = "Toner")  %>%
    
    # Data Layers
      # First Data Layer: Stunting 20% poorer
    addPolygons(group="Stunting 1st wealth quintile",
                stroke = FALSE, fillOpacity = 0.5, smoothFactor = 0.5, 
                color = ~colorNumeric("Spectral", wq1)(wq1),
                popup = paste("Country:",world_spdf$NAME,"<br/>",
                              "Stunting in 1st quintile:", world_spdf$wq1,"%","<br/>")) %>%
    #Add legends
    #addLegend("bottomright", pal = colorNumeric("Spectral", world_spdf$wq1), 
     #         values = ~wq1, title = "% Stunting 1st WQ", opacity = 0.5) %>%
     
    # Second Data Layer: College
    addPolygons(group="Stunting 5th wealth quintile", data=world_spdf,
                stroke = FALSE, fillOpacity = 0.5, smoothFactor = 0.5, 
                color = ~colorNumeric("Spectral", wq5)(wq5),
                popup = paste("Country:",world_spdf$NAME,"<br/>",
                              "Stunting in 5th quintile:", world_spdf$wq5,"%","<br/>")) %>%
    #Add legends
    addLegend("bottomright", pal = colorNumeric("Spectral", world_spdf$wq5), 
              values = ~wq5, title = "% Stunting 5th WQ", opacity = 0.5) %>%
  
    # Layers control
    addLayersControl(
    baseGroups = c("OpenStreetMap", "Toner", "Toner Lite"),
    overlayGroups = c("Stunting 1st wealth quintile","Stunting 5th wealth quintile"),
    options = layersControlOptions(collapsed = TRUE) )
```

